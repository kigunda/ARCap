/*
 * NetworkHandler.h
 *
 *  Created on: 2014-03-03
 *      Author: Kenan Kigunda
 */

#ifndef NETWORKHANDLER_H_
#define NETWORKHANDLER_H_

using namespace std;
#include <string>

#include "altera_up_avalon_rs232.h"

#include "DataSource.h"
#include "Debug.h"
#include "NetworkCommand.h"
#include "Status.h"

struct WifiMessage;

#define NETWORK_HANDLER_UPDATE_TIME_MILLIS			50

/*
 * The network handler manages communications between the rovers and the remote players.
 * It provides a high-level view of the interfacing of the wifi module.
 */
class NetworkHandler: public DataSource {
public:
	NetworkHandler();
	virtual ~NetworkHandler();

	/*
	 * Initializes this data source.
	 * @return OK if there are no initialization errors
	 */
	Status init();

	/*
	 * Updates this data source.
	 * @return OK if all incoming network messages have been read and posted to all listeners without error
	 */
	Status update();

	/*
	 * Sends a network command to the remote server.
	 * @param command - the command to send
	 * @param parameters - the parameters specifying further command details,
	 * in the format param1=value1&param2=value2&...
	 */
	Status send(NetworkCommand command, string parameters);
private:
	alt_up_rs232_dev *wifi_dev;

	/*
	 * Writes a message to the wifi UART device.
	 * The message will be used to configure the Xbee wifi module, if the device is in configuration mode,
	 * or it will be forwarded through TCP to the remote server given by DL (the destination IP address)
	 * and DE (the destination IP port).
	 * @param message - the message to write
	 */
	void wifiWrite(char *message);

	/*
	 * Listens on the wifi UART until a full message is received.
	 * @param stop - the string marking the end of the message
	 * @return the message that was received, which must be freed by the caller
	 */
	WifiMessage *wifiReadUntil(char *stop);

	/*
	 * Reads the latest configuration response from the Xbee wifi module.
	 * @return the message object containing the response
	 */
	WifiMessage *wifiConfigStartRead();

	/*
	 * Reads the latest configuration response from the Xbee wifi module.
	 */
	void wifiConfigRead();

	/*
	 * Sends a configuration command to the Xbee wifi module.
	 * @param command - the command to send
	 */
	void wifiConfigStartSend(char *command);

	/*
	 * Sends a configuration command to the Xbee wifi module,
	 * then waits for and prints the response.
	 * @param command - the command to send
	 */
	void wifiConfigSend(char *command);

	/**
	 * Sends the sequence to enter configuration mode on the Xbee wifi module.
	 */
	void wifiConfigEnter();

};

#if defined(NETWORKHANDLER_SEND_DEBUG) || defined(NETWORKHANDLER_DEBUG) || defined(DEBUG)
#define NETWORKHANDLER_SEND_LOG(info) info
#else
#define NETWORKHANDLER_SEND_LOG(info)
#endif

#if defined(NETWORKHANDLER_RECEIVE_DEBUG) || defined(NETWORKHANDLER_DEBUG) || defined(DEBUG)
#define NETWORKHANDLER_RECEIVE_LOG(info) info
#else
#define NETWORKHANDLER_RECEIVE_LOG(info)
#endif

#endif /* NETWORKHANDLER_H_ */
