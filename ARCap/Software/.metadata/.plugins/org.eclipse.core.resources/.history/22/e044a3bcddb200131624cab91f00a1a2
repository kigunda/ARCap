/*
 * InfraredReceiver.h
 *
 *  Created on: 2014-03-23
 *      Author: kigunda
 */

#ifndef INFRAREDRECEIVER_H_
#define INFRAREDRECEIVER_H_

#include "Status.h"

/* Polls the infrared receivers. */
void infrared_handler_update_task(void* pdata) {
	printf("InfraredReceiver [task: update, status: start]\n");
	while (true) {
		try {
			// Update the infrared handler.
			infrared->update();
		} catch (ARCapException &e) {
			// If exception, print.
			INFRAREDRECEIVER_LOG(printf("%s", e.what()));
		}
		// [Test] Wait for 1 second.
		OSTimeDlyHMSM(0, 0, 1, 0);
	}
}

/**
 * Reads input from the infrared receivers through the analog-to-digital converter
 * (ADC) and posts infrared hit events to a listener.
 */
class InfraredReceiver {
public:
	/**
	 * Creates a new infrared receiver.
	 * @throw ADCOpenException if the receiver cannot connect to the analog-to-digital converter
	 */
	InfraredReceiver();
	virtual ~InfraredReceiver();

	/**
	 * Sets the listener to which the infrared readings will be posted.
	 * @param queue - the queue to set as the listener
	 */
	void setListener(OS_EVENT *queue);

	/*
	 * Updates this receiver. The receiver will read the ADC and post the readings to the listener.
	 * @throw PostException if the reading cannot be posted to the listener
	 */
	void update();

private:
	/* The analog-to-digital converter control device used to read from the infrared receivers. */
	alt_up_de0_nano_adc_dev *adc_dev;

	/* The listener queue to which infrared receive events will be posted. */
	OS_EVENT *listener;

	/*
	 * Reads the level of the given receive channel.
	 * @param channel - the number of the ADC channel to read
	 * @return the 12-bit level read from the channel, indicating the amount of infrared light
	 * hitting the receivers
	 * */
	unsigned int read(int channel);

	/*
	 * Posts the given infrared level readings to the listener.
	 * @param level - the level read by the infrared receivers
	 * @throw PostException if the reading cannot be posted to the listener
	 */
	void post(unsigned int level);

};

class ADCOpenException : ARCapException {
public:
	virtual const char *what() const {
		return "Failed to open connection to analog-to-digital converter.";
	}
};

#if defined(INFRAREDRECEIVER_DEBUG) || defined(DEBUG)
#define INFRAREDRECEIVER_LOG(info) info
#else
#define INFRAREDRECEIVER_LOG(info)
#endif

#endif /* INFRAREDRECEIVER_H_ */
